function haveSession(e){for(var n in e)if(!e[n])return n;return null}function _stopStream(e){var n="#"+e,t=document.querySelector(n).querySelector(".localVideo").srcObject,o=document.querySelector(n).querySelector(".remoteVideo").srcObject;_remoteStream[e]&&_remoteStream[e].getTracks().forEach(e=>e.stop()),_localStream[e]&&_localStream[e].getTracks().forEach(e=>e.stop()),t&&(t.getTracks().forEach(e=>e.stop()),t=null),o&&(o.getTracks().forEach(e=>e.stop()),o=null)}function _ringPause(e){"outgoing"===e.direction?(document.querySelector("#ringback").pause(),document.querySelector("#ringback").currentTime=0):(document.querySelector("#ringing").pause(),document.querySelector("#ringing").currentTime=0)}function _afterAccept(e,n){var t=null,o="#"+n;$(o).find(".close-phone").removeClass("close-phone");var s=e.remote_identity.display_name?"in: "+e.remote_identity.display_name:"out: "+e.local_identity.uri.user;_PeerConnection=e.connection,_localStream[n]=new MediaStream,_PeerConnection.getSenders().forEach(function(e){e.track&&"ended"!=e.track.readyState&&_localStream[n].addTrack(e.track)}),_remoteStream[n]=new MediaStream,_PeerConnection.getReceivers().forEach(function(e){t+=e.track.kind,e.track&&"ended"!=e.track.readyState&&0==e.track.muted&&_remoteStream[n].addTrack(e.track)}),(mediaConstraints&&!mediaConstraints.video||-1==t.indexOf("video"))&&(s+="【语音模式】",document.querySelector(o).querySelector(".toggle-camera").style="display:none;"),_localStream[n]&&(document.querySelector(o).querySelector(".localVideo").srcObject=_localStream[n]),_remoteStream[n]&&(document.querySelector(o).querySelector(".remoteVideo").srcObject=_remoteStream[n],sessionStorage.getItem("audiooutput")&&"no"!=sessionStorage.getItem("audiooutput")&&COMMON.attachSinkId(document.querySelector(o).querySelector(".remoteVideo"),sessionStorage.getItem("audiooutput"))),s&&(document.querySelector(o).querySelector(".displayName").innerHTML=s),_PeerConnection.addEventListener("addstream",function(n){for(var t in _session)if(_session[t]==e){var o="#"+t;$(o).find(".screenVideo")[0].srcObject=n.stream}});var i=null;_PeerConnection.addEventListener("track",function(n){for(var t in _session)if(_session[t]==e)var o="#"+t;var s=$(o).find(".screenVideo")[0];n.streams&&n.streams[0]?s.srcObject=n.streams[0]:(i=new MediaStream,s.srcObject=i,i.addTrack(n.track))}),COMMON.changePage("session",_tmpTarget)}function _UAMessageSubject(e){["connecting","connected","disconnected","registered","unregistered","registrationFailed","newRTCSession","newMessage"].map(n=>{e.ua.on(n,function(e){console.log(`UAEvent: ${n}`,e)})})}function _RTCSessionMessageSubject(e){["peerconnection","connecting","sending","progress","accepted","confirmed","ended","failed","newDTMF","newInfo","hold","unhold","muted","unmuted","reinvite","update","refer","replaces","sdp","icecandidate","getusermediafailed","peerconnection:createofferfailed","peerconnection:createanswerfailed","peerconnection:setlocaldescriptionfailed","peerconnection:setremotedescriptionfailed"].map(n=>{e.on(n,function(e){console.info(`RTCSessionEvent: ${n}`,e)})})}function _UAStatusSubject(e){Object.keys(_uaEvent).map(n=>{e.ua.on(n,function(e){_uaEvent[n](e)})})}function _RTCSessionStatusSubject(e,n){Object.keys(_rtcSessionEvent).map(t=>{e.on(t,function(o){_rtcSessionEvent[t](o,e,n)})})}function _setVideoStream(e,n){var t="#"+n;document.querySelector(t).querySelector(".localVideo").srcObject=e,document.querySelector(t).querySelector(".localVideo").play()}function WebRTC(e={}){this.account=e.account||" ",this.password=e.password||"",this.domain=e.domain||" ",this.wss=e.wss||" ",this.socket=new FlyInnWeb.WebSocketInterface(this.wss),this.configuration={sockets:[this.socket],uri:"sip:"+this.account+"@"+this.domain,contact_uri:"sip:"+this.account+"@"+this.account+".invalid;transport=ws",password:this.password,display_name:this.account,register:!0,session_timers:!1,register_expires:900},this.ua=new FlyInnWeb.UA(this.configuration)}var App=window.App||{},COMMON=window.App.common,_ua=null,_session={a:null,b:null,c:null,d:null},notify=!1,_tmpTarget=null,_incomingSession=null,_tmpSession=null,_PeerConnection=null,_localStream={one:null,two:null},_remoteStream={one:null,two:null},_getStatsResult=null,_sipCode={busy:{status_code:486},reject:{status_code:403}},mediaConstraints=null,_uaEvent={registered:function(e){COMMON.changePage("main")},registrationFailed:function(e){COMMON.changePage("login"),M.toast({html:e.cause})},newRTCSession:function(e){if(_tmpSession=e.session,_tmpTarget=haveSession(_session),"remote"===e.originator){if(!_tmpTarget||_incomingSession)return console.warn('incoming call replied with 486 "Busy Here"'),void e.session.terminate(_sipCode.busy);_incomingSession=e.session}_RTCSessionMessageSubject(e.session),_RTCSessionStatusSubject(e.session,e)},newMessage:function(e){}},_rtcSessionEvent={progress:function(e,n,t){var o="#"+_tmpTarget;"outgoing"===n.direction?(COMMON.changePage("calling",_tmpTarget),document.querySelector("#ringback").play()):(console.log(t),document.querySelector(o).querySelector(".display-name").innerHTML=t.request.from.display_name,COMMON.changePage("incoming",_tmpTarget),document.querySelector("#ringing").play()),_session[_tmpTarget]=n},sdp:function(e){"offer"==e.type?e.sdp=e.sdp.replace(/a=setup:passive/g,"a=setup:actpass"):"answer"==e.type&&(e.sdp=e.sdp.replace(/a=setup:actpass/g,"a=setup:actpass")),e.sdp=e.sdp.replace(/a=ssrc.*\r\n/g,""),e.sdp=e.sdp.replace(/a=msid.*\r\n/g,""),e.sdp=e.sdp.replace(/a=mid.*\r\n/g,""),e.sdp=e.sdp.replace(/a=extmap.*\r\n/g,""),e.sdp=e.sdp.replace(/a=group:BUNDLE.*\r\n/,""),e.sdp=e.sdp.replace(/a=candidate.*169\.254.*\r\n/g,""),e.sdp=e.sdp.replace(/a=candidate.*tcp.*\r\n/g,""),e.sdp=e.sdp.replace(/a=candidate.*([a-f0-9]{1,4}(:[a-f0-9]{1,4}){7}|[a-f0-9]{1,4}(:[a-f0-9]{1,4}){0,7}::[a-f0-9]{0,4}(:[a-f0-9]{1,4}){0,7}).*\r\n/g,"")},failed:function(e,n,t){for(var o in _session)_session[o]==n&&(_session[o]=null,COMMON.changePage("normal",o),_stopStream(o));_ingSession=null,_ringPause(n),M.toast({html:e.cause}),_getStatsResult&&_getStatsResult.nomore(),_tmpTarget=null,_incomingSession=null},accepted:function(e,n,t){_ringPause(n),_afterAccept(n,_tmpTarget),_incomingSession=null},ended:function(e,n,t){var o=null;for(var s in _session)_session[s]==n&&(_session[s]=null,o=s);_stopStream(o),M.toast({html:e.cause}),COMMON.changePage("normal",o)},newDTMF:function(e,n,t){"remote"===e.originator&&M.toast({html:`newDTMF: ${e.request.body}`})},newInfo:function(e,n,t){if("remote"===e.originator){var o=JSON.parse(e.request.body);"debug"!==o.type&&M.toast({html:`newInfo: ${e.request.body}`})}},refer:function(e,n){e.accepted()},reinvite:function(e,n,t){var o=null;for(var s in _session)_session[s]==n&&(o="#"+s);e.request.headers["X-Action"]&&("shareScreen"==e.request.headers["X-Action"][0].raw?o&&$(o).find(".screen-video").removeClass("hide"):"stopShareScreen"==e.request.headers["X-Action"][0].raw&&o&&$(o).find(".screen-video").addClass("hide"))},newNotify:function(e,n,t){"remote"===e.originator&&(notify=!0,"talk"==e.request.event.event?n.isEstablished()?n.isOnHold()&&n.unhold():n.answer({rtcAnswerConstraints:{audio:!0,video:!1}}):"hold"==e.request.event.event&&n.hold())}};WebRTC.prototype.connect=function(){this.ua.start(),_UAMessageSubject(this),_UAStatusSubject(this)},WebRTC.prototype.stop=function(){this.ua.stop()},WebRTC.prototype.unregister=function(){this.ua.isRegistered()&&this.ua.unregister()},WebRTC.prototype.call=function(e,n){mediaConstraints=sessionStorage.getItem("constraints")?JSON.parse(sessionStorage.getItem("constraints")):{audio:!0,video:!1},"video"==n?(mediaConstraints.video||(mediaConstraints.video=!0),mediaConstraints.audio||(mediaConstraints.audio=!0)):"audio"==n&&(mediaConstraints.video&&(mediaConstraints.video=!1),mediaConstraints.audio||(mediaConstraints.audio=!0)),this.session=this.ua.call("sip:"+e+"@"+this.domain,{mediaConstraints:mediaConstraints,pcConfig:pcConfig})},WebRTC.prototype.answer=function(){mediaConstraints=null,_incomingSession.answer({mediaConstraints:"audio"==phoneModal?{video:!1,audio:!0}:{audio:!0,video:!0}})},WebRTC.prototype.cancel=function(){_tmpSession.terminate()},WebRTC.prototype.reject=function(e){_incomingSession.terminate(_sipCode.reject)},WebRTC.prototype.youanswer=function(e){_tmpSession.sendInfo("application/json","",{extraHeaders:["event: talk"]})},WebRTC.prototype.hangup=function(e){if(e&&_session[e])_session[e].terminate();else for(var n in _session)_session[n].terminate()},WebRTC.prototype.closeMic=function(e){_session[e]&&_session[e].mute()},WebRTC.prototype.openMic=function(e){_session[e]&&_session[e].unmute()},WebRTC.prototype.hold=function(e){_session[e]&&_session[e].hold()},WebRTC.prototype.unhold=function(e){_session[e]&&_session[e].unhold()},WebRTC.prototype.closeCam=function(e){_session[e]&&_session[e].mute({audio:!1,video:!0})},WebRTC.prototype.openCam=function(e){_session[e]&&_session[e].unmute({audio:!1,video:!0})},WebRTC.prototype.sendDTMF=function(e,n){_session[n]&&_session[n].sendDTMF(e)},WebRTC.prototype.sendInfo=function(e,n){_session[n]&&_session[n].sendInfo("application/json",e)},WebRTC.prototype.switchStream=function(e,n){window.stream=e,_session&&_PeerConnection&&(_setVideoStream(e),e.getVideoTracks().forEach(function(e){var n=_PeerConnection.getSenders().find(function(n){return n.track.kind==e.kind});n.replaceTrack(e)}))},WebRTC.prototype.shareScreen=function(e,n){window.shareStraem=e,_session&&_PeerConnection&&(e.getVideoTracks().forEach(function(e){var n=_PeerConnection.getSenders().find(function(n){if(n.track)return n.track.label==e.label});n?n.replaceTrack(e):_PeerConnection.addTrack(e)}),_session[n].renegotiate({extraHeaders:["X-Action: shareScreen"]})),isShareScreen=!0},WebRTC.prototype.stopShare=function(e){_session&&_PeerConnection&&(_PeerConnection.getSenders().find(function(e){e.track&&-1==e.track.label.indexOf("screen")&&-1==e.track.label.indexOf("window")&&-1==e.track.label.indexOf("web")||(e.track&&e.track.stop(),_PeerConnection.removeTrack(e))}),_session[e].renegotiate({extraHeaders:["X-Action: stopShareScreen"]}))},App.WebRTC=WebRTC,window.App=App;