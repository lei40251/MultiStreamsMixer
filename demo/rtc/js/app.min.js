(function(e){function t(){var t=sessionStorage.getItem("video").split(","),o=JSON.parse(sessionStorage.getItem("constraints")),a=null;t.length<1?M.toast({html:"no camera can switch！"}):y<t.length&&(e.stream&&e.stream.getTracks().forEach(function(e){e.stop()}),a=o?{audio:o.audio,video:{deviceId:{exact:device}}}:{audio:!0,video:{deviceId:{exact:t[y]}}},navigator.mediaDevices.getUserMedia(a).then(e=>p.switchStream(e)).catch(c),y++),y>=t.length&&(y=0)}function o(){var e={},t={};e="no"!=P.value&&{deviceId:{exact:P.value}},t="no"!=R.value&&{deviceId:{exact:R.value},frameRate:B.value},k={video:t,audio:e},sessionStorage.setItem("audiooutput",G.value),sessionStorage.setItem("constraints",JSON.stringify(k))}function a(e){var t=[],o=[],a=[],n='<option value="no">无</option>';const c=Q.map(e=>e.value);if(Q.forEach(e=>{for(;e.firstChild;)e.removeChild(e.firstChild);e.innerHTML=e.innerHTML+n}),e.forEach(e=>{var n=document.createElement("option");n.value=e.deviceId,"audioinput"===e.kind?(t.push(e.deviceId),n.text=e.label||`microphone ${P.length+1}`,P.appendChild(n)):"audiooutput"===e.kind?(a.push(e.deviceId),n.text=e.label||`speaker ${G.length+1}`,G.appendChild(n)):"videoinput"===e.kind&&(o.push(e.deviceId),n.text=e.label||`camera ${R.length+1}`,R.appendChild(n))}),sessionStorage.getItem("constraints")){sessionStorage.getItem("constraints")}Q.forEach((e,t)=>{Array.prototype.slice.call(e.childNodes).some(e=>e.value===c[t])&&(e.value=c[t])}),sessionStorage.setItem("audio",t),sessionStorage.setItem("video",o),M.FormSelect.init(document.querySelectorAll("select"))}function n(t){return e.stream=t,V.srcObject=t,G.value&&"no"!=G.value&&f.attachSinkId(V,G.value),navigator.mediaDevices.enumerateDevices()}function c(e){console.error("navigator.getUserMedia error: ",e),M.toast({html:e})}function i(){sessionStorage.getItem("constraints")&&JSON.parse(sessionStorage.getItem("constraints"));P.innerHTML="",G.innerHTML="",R.innerHTML="",l(),s()}function s(t){if(t)navigator.mediaDevices.getUserMedia(t).then(n).then(a).catch(c);else{e.stream&&e.stream.getTracks().forEach(e=>{e.stop()});const t=P.value,o=R.value;if("no"==t&&"no"==o)return void M.toast({html:"必须选择音频和视频中的一个！"});const i={audio:!!t&&("no"!=t&&""!=t&&{deviceId:!!t&&{exact:t}}),video:!!o&&("no"!=o&&""!=o&&{deviceId:!!o&&{exact:o}})};(i.video||i.audio)&&navigator.mediaDevices.getUserMedia(i).then(n).then(a).catch(c)}}function r(){V.srcObject&&V.srcObject.getTracks()&&V.srcObject.getTracks().forEach(e=>e.stop()),V.srcObject=null}function l(){navigator.mediaDevices.enumerateDevices().then(a).catch(c)}function u(e){var t=e.classList;t.contains("close-camera")?(p.openCam($(e).closest(".main").data("target")),t.toggle("close-camera")):(p.closeCam($(e).closest(".main").data("target")),t.toggle("close-camera"))}function d(e){var t=e.classList;t.contains("close-microphone")?(p.openMic($(e).closest(".main").data("target")),t.toggle("close-microphone")):(p.closeMic($(e).closest(".main").data("target")),t.toggle("close-microphone"))}function m(e){var t=e.classList;t.contains("close-phone")?(p.unhold($(e).closest(".main").data("target")),t.toggle("close-phone")):(p.hold($(e).closest(".main").data("target")),t.toggle("close-phone"))}function g(e){Y&&(p.stopShare(e),Y=!1),Y=!0,navigator.mediaDevices.getDisplayMedia({video:!0}).then(t=>{t.addEventListener("inactive",t=>{console.log("Capture stream inactive - stop recording!"),p.stopShare(e)}),p.shareScreen(t,e)}).catch(c)}function h(){sessionStorage.setItem("account",document.querySelector("#account").value),sessionStorage.setItem("password",document.querySelector("#password").value),v()}function v(){var t=f.handleGetQuery("account"),o=sessionStorage.getItem("account"),a=f.handleGetQuery("password"),n=sessionStorage.getItem("password");t?(S=t,sessionStorage.setItem("account",t)):o&&(S=o),a?(I=a,sessionStorage.setItem("password",a)):n&&(I=n),S?(p=new e.App.WebRTC({account:S,password:I,domain:domain,wss:wss}),p.connect()):f.changePage("login"),l()}var f=e.App.common,p=null,S=null,I=null,k={},y=0,w=document.querySelector("#linkman"),q=$(".call"),T=$(".cancel"),b=$(".youanswer"),D=$(".hangup"),x=$(".reject"),C=$(".answer"),A=$(".dialpad"),E=$(".modal-close"),L=$(".change-camera"),O=$(".toggle-camera"),j=$(".toggle-microphone"),F=$(".share-screen"),H=document.querySelector("#DTMF"),J=document.querySelector("#info-message"),N=document.querySelector("#sendInfo"),U=$(".toggle-phone"),P=$("#switch-microphone")[0],R=$("#switch-camera")[0],G=$("#switch-audiooutput")[0],Q=[P,G,R],B=document.querySelector("#change-frameRate"),W=document.querySelector("#save-contraints"),z=document.querySelector("#login"),K=document.querySelector("#logout"),V=document.querySelector("#test-video");JsSIP.debug.disable("JsSIP:*"),M.FormSelect.init(document.querySelectorAll("select")),M.Modal.init(document.querySelectorAll("#dialpad-modal"),{dismissible:!1}),M.Modal.init(document.querySelectorAll("#settings-modal"),{onOpenStart:i,onCloseEnd:r});M.FloatingActionButton.init(document.querySelectorAll(".fixed-action-btn"));var X=document.querySelector(".small-video");new Draggabilly(X,{});q.click(function(){w.value?p.call(w.value,$(this).data("method")):M.toast({html:"请输入客服号码！"})}),T.click(function(){p.cancel($(this).closest(".main").data("target"))}),b.click(function(){p.youanswer($(this).closest(".main").data("target"))}),C.click(function(){p.answer($(this).closest(".main").data("target"))}),D.click(function(){p.hangup($(this).closest(".main").data("target"))}),x.click(function(){p.reject($(this).closest(".main").data("target"))}),O.click(function(){u(this)}),j.click(function(){d(this)}),U.click(function(){m(this)}),F.click(function(){g($(this).closest(".main").data("target"))}),A.click(function(){$(".dtmfTarget").val($(this).closest(".main").data("target"))}),E.click(function(){$(".dtmfTarget").val()}),H.querySelectorAll("button").forEach(e=>{e.dataset.value&&(e.onclick=function(e){$(".dtmfTarget").val()&&p.sendDTMF(this.dataset.value,$(".dtmfTarget").val())})}),N.onclick=function(){J.value?p.sendInfo(J.value,$(".dtmfTarget").val()):M.toast({html:"请输入消息内容！"})},W.onclick=function(){o()},z.onclick=function(){h()},K.onclick=function(){p.unregister(),sessionStorage.clear(),e.location.replace("index.html")},L.onclick=function(e){t()},e.onbeforeunload=function(){p&&p.stop()},R.onchange=function(){s()},P.onchange=function(){s()},G.onchange=function(){s()};var Y=!1;v()})(window);