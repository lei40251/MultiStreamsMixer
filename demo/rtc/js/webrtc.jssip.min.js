(function(e){function n(e){for(var n in e)if(!e[n])return n;return null}function t(e){var n="#"+e,t=document.querySelector(n).querySelector(".localVideo").srcObject,o=document.querySelector(n).querySelector(".remoteVideo").srcObject;v[e]&&v[e].getTracks().forEach(e=>e.stop()),S[e]&&S[e].getTracks().forEach(e=>e.stop()),t&&(t.getTracks().forEach(e=>e.stop()),t=null),o&&(o.getTracks().forEach(e=>e.stop()),o=null)}function o(e){"outgoing"===e.direction?(document.querySelector("#ringback").pause(),document.querySelector("#ringback").currentTime=0):(document.querySelector("#ringing").pause(),document.querySelector("#ringing").currentTime=0)}function r(e,n){var t=null,o="#"+n;$(o).find(".close-phone").removeClass("close-phone");var r=e.remote_identity.display_name?"in: "+e.remote_identity.display_name:"out: "+e.local_identity.uri.user;y=e.connection,S[n]=new MediaStream,console.log(y),y.getSenders().forEach(function(e){e.track&&S[n].addTrack(e.track)}),v[n]=new MediaStream,y.getReceivers().forEach(function(e){t+=e.track.kind,e.track&&v[n].addTrack(e.track)}),(q&&!q.video||-1==t.indexOf("video"))&&(r+="【语音模式】",document.querySelector(o).querySelector(".toggle-camera").style="display:none;"),S[n]&&(document.querySelector(o).querySelector(".localVideo").srcObject=S[n]),v[n]&&(document.querySelector(o).querySelector(".remoteVideo").srcObject=v[n],sessionStorage.getItem("audiooutput")&&"no"!=sessionStorage.getItem("audiooutput")&&f.attachSinkId(document.querySelector(o).querySelector(".remoteVideo"),sessionStorage.getItem("audiooutput"))),r&&(document.querySelector(o).querySelector(".displayName").innerHTML=r),y.addEventListener("addstream",function(n){for(var t in p)if(p[t]==e){var o="#"+t;$(o).find(".screenVideo")[0].srcObject=n.stream}});var i=null;y.addEventListener("track",function(n){for(var t in p)if(p[t]==e)var o="#"+t;var r=$(o).find(".screenVideo")[0];n.streams&&n.streams[0]?r.srcObject=n.streams[0]:(i=new MediaStream,r.srcObject=i,i.addTrack(n.track))}),f.changePage("session",m)}function i(e){["connecting","connected","disconnected","registered","unregistered","registrationFailed","newRTCSession","newMessage"].map(n=>{e.ua.on(n,function(e){console.log(`UAEvent: ${n}`,e)})})}function c(e){["peerconnection","connecting","sending","progress","accepted","confirmed","ended","failed","newDTMF","newInfo","hold","unhold","muted","unmuted","reinvite","update","refer","replaces","sdp","icecandidate","getusermediafailed","peerconnection:createofferfailed","peerconnection:createanswerfailed","peerconnection:setlocaldescriptionfailed","peerconnection:setremotedescriptionfailed"].map(n=>{e.on(n,function(e){console.info(`RTCSessionEvent: ${n}`,e)})})}function a(e){Object.keys(b).map(n=>{e.ua.on(n,function(e){b[n](e)})})}function s(e,n){Object.keys(T).map(t=>{e.on(t,function(o){T[t](o,e,n)})})}function u(e,n){var t="#"+n;document.querySelector(t).querySelector(".localVideo").srcObject=e,document.querySelector(t).querySelector(".localVideo").play()}function d(e={}){this.account=e.account||" ",this.password=e.password||"",this.domain=e.domain||" ",this.wss=e.wss||" ",this.socket=new JsSIP.WebSocketInterface(this.wss),this.configuration={sockets:[this.socket],uri:"sip:"+this.account+"@"+this.domain,contact_uri:"sip:"+this.account+"@"+this.account+".invalid;transport=ws",password:this.password,display_name:this.account,register:!0,session_timers:!1,register_expires:900,user_agent:"UA/1.0"},this.ua=new JsSIP.UA(this.configuration)}var l=e.App||{},f=e.App.common,p={a:null,b:null,c:null,d:null},m=null,g=null,h=null,y=null,S={one:null,two:null},v={one:null,two:null},k=null,w={busy:{status_code:486},reject:{status_code:403}},q=null,b={registered:function(e){f.changePage("main")},registrationFailed:function(e){f.changePage("login"),M.toast({html:e.cause})},newRTCSession:function(e){if(h=e.session,m=n(p),"remote"===e.originator){if(!m||g)return console.warn('incoming call replied with 486 "Busy Here"'),void e.session.terminate(w.busy);g=e.session}c(e.session),s(e.session,e)},newMessage:function(e){}},T={progress:function(e,n,t){var o="#"+m;"outgoing"===n.direction?(f.changePage("calling",m),document.querySelector("#ringback").play()):(console.log(t),document.querySelector(o).querySelector(".display-name").innerHTML=t.request.from.display_name,f.changePage("incoming",m),document.querySelector("#ringing").play()),p[m]=n},sdp:function(e){e.sdp=e.sdp.replace(/a=candidate.*([a-f0-9]{1,4}(:[a-f0-9]{1,4}){7}|[a-f0-9]{1,4}(:[a-f0-9]{1,4}){0,7}::[a-f0-9]{0,4}(:[a-f0-9]{1,4}){0,7}).*\r\n/g,"")},failed:function(e,n,r){for(var i in p)p[i]==n&&(p[i]=null,f.changePage("normal",i),t(i));_ingSession=null,o(n),M.toast({html:e.cause}),k&&k.nomore(),m=null,g=null},accepted:function(e,n,t){o(n),r(n,m),g=null},ended:function(e,n,o){var r=null;for(var i in p)p[i]==n&&(p[i]=null,r=i);t(r),M.toast({html:e.cause}),f.changePage("normal",r)},newDTMF:function(e,n,t){"remote"===e.originator&&M.toast({html:`newDTMF: ${e.request.body}`})},newInfo:function(e,n,t){if("remote"===e.originator){var o=JSON.parse(e.request.body);"debug"!==o.type&&M.toast({html:`newInfo: ${e.request.body}`})}},reinvite:function(e,n,t){var o=null;for(var r in p)p[r]==n&&(o="#"+r);e.request.headers["X-Action"]&&("shareScreen"==e.request.headers["X-Action"][0].raw?o&&$(o).find(".screen-video").removeClass("hide"):"stopShareScreen"==e.request.headers["X-Action"][0].raw&&o&&$(o).find(".screen-video").addClass("hide"))},newNotify:function(e,n,t){"remote"===e.originator&&(!0,"talk"==e.request.event.event?n.isEstablished()?n.isOnHold()&&n.unhold():n.answer({rtcOfferConstraints:{offerToReceiveAudio:1,offerToReceiveVideo:0,DtlsSrtpKeyAgreement:0}}):"hold"==e.request.event.event&&n.hold())}};d.prototype.connect=function(){this.ua.start(),i(this),a(this)},d.prototype.stop=function(){this.ua.stop()},d.prototype.unregister=function(){this.ua.isRegistered()&&this.ua.unregister()},d.prototype.call=function(e,n){q=sessionStorage.getItem("constraints")?JSON.parse(sessionStorage.getItem("constraints")):{audio:!0,video:!0},"video"==n?(q.video||(q.video=!0),q.audio||(q.audio=!0)):"audio"==n&&(q.video&&(q.video=!1),q.audio||(q.audio=!0)),this.session=this.ua.call("sip:"+e+"@"+this.domain,{extraHeaders:["X-Token: 2c8a1be510764ad222ebcc4ffd0f9775"],mediaConstraints:q,rtcOfferConstraints:{offerToReceiveAudio:q.audio?1:0,offerToReceiveVideo:q.video?1:0},pcConfig:pcConfig})},d.prototype.answer=function(){q=null,g.answer()},d.prototype.cancel=function(){h.terminate()},d.prototype.reject=function(e){g.terminate(w.reject)},d.prototype.youanswer=function(e){h.sendInfo("application/json","",{extraHeaders:["event: talk"]})},d.prototype.hangup=function(e){if(e&&p[e])p[e].terminate();else for(var n in p)p[n].terminate()},d.prototype.closeMic=function(e){p[e]&&p[e].mute()},d.prototype.openMic=function(e){p[e]&&p[e].unmute()},d.prototype.hold=function(e){p[e]&&p[e].hold()},d.prototype.unhold=function(e){p[e]&&p[e].unhold()},d.prototype.closeCam=function(e){p[e]&&p[e].mute({audio:!1,video:!0})},d.prototype.openCam=function(e){p[e]&&p[e].unmute({audio:!1,video:!0})},d.prototype.sendDTMF=function(e,n){p[n]&&p[n].sendDTMF(e)},d.prototype.sendInfo=function(e,n){p[n]&&p[n].sendInfo("application/json",e)},d.prototype.switchStream=function(n,t){e.stream=n,p&&y&&(u(n),n.getVideoTracks().forEach(function(e){var n=y.getSenders().find(function(n){return n.track.kind==e.kind});n.replaceTrack(e)}))},d.prototype.shareScreen=function(n,t){e.shareStraem=n,p&&y&&(n.getVideoTracks().forEach(function(e){var n=y.getSenders().find(function(n){if(n.track)return n.track.label==e.label});n?n.replaceTrack(e):y.addTrack(e)}),p[t].renegotiate({extraHeaders:["X-Action: shareScreen"]})),isShareScreen=!0},d.prototype.stopShare=function(e){p&&y&&(y.getSenders().find(function(e){e.track&&-1==e.track.label.indexOf("screen")&&-1==e.track.label.indexOf("window")&&-1==e.track.label.indexOf("web")||(e.track&&e.track.stop(),y.removeTrack(e))}),p[e].renegotiate({extraHeaders:["X-Action: stopShareScreen"]}))},l.WebRTC=d,e.App=l})(window);